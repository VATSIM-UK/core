#!/usr/bin/env bash

# pre-commit hook for Laravel Pint
# Auto-fix staged files and automatically add them to the commit.

if [ -f "$HOME/.bashrc" ]; then
    . "$HOME/.bashrc"
fi

set -euo pipefail

# Get staged PHP files
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)
[ -z "$staged_files" ] && exit 0

echo "Running Pint..."
composer lint -- --quiet "$staged_files" || true

# Check if Pint changed any of the staged files
fixed_files=$(git diff --name-only -- "$staged_files")

if [ -n "$fixed_files" ]; then
    echo
    echo "✨ Pint fixed some files. Adding them to the commit:"
    echo "$fixed_files"

    # Add the fixed files back to staging
    echo "$fixed_files" | xargs git add

    echo "✅ Fixed files have been added to the commit."
else
    echo "✅ Pint made no changes."
fi

exit 0
